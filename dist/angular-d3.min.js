angular.module("angular-d3",[]).factory("angularD3Svc",[function(){var t=0;return{getId:function(){return"uid"+t++}}}]).directive("barChart",function(){return{restrict:"E",replace:!1,scope:{ngData:"="},link:function(t,e){var r=d3.select(e[0]);t.$watch("ngData",function(t){if(t){var a=d3.select(e[0].parentNode).node().getBoundingClientRect(),n={top:20,right:20,bottom:30,left:50},i=a.width-n.left-n.right,l=a.height-n.top-n.bottom,c=d3.scale.ordinal().rangeRoundBands([0,i],.1),o=d3.scale.linear().range([l,0]),d=d3.svg.axis().scale(c).orient("bottom"),s=d3.svg.axis().scale(o).orient("left").ticks(10);r.selectAll("*").remove();var u=r.append("svg").attr("class","barChart").attr("width",i+n.left+n.right).attr("height",l+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");c.domain(t.data.map(function(t){return t.x})),o.domain([0,d3.max(t.data,function(t){return t.y})]),u.append("g").attr("class","x axis").attr("transform","translate(0,"+l+")").call(d),u.append("g").attr("class","y axis").call(s).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(t.axis.y),u.selectAll(".bar").data(t.data).enter().append("rect").attr("class","bar").attr("x",function(t){return c(t.x)}).attr("width",c.rangeBand()).attr("y",function(t){return o(t.y)}).attr("height",function(t){return l-o(t.y)})}})}}}).directive("calendarHeatmap",function(){return{restrict:"E",replace:!1,scope:{ngData:"=",width:"@",height:"@",cellSize:"="},link:function(t,e){var r=d3.select(e[0]);t.$watch("ngData",function(e){function a(t){var e=new Date(t.getFullYear(),t.getMonth()+1,0),r=t.getDay(),a=d3.time.weekOfYear(t),n=e.getDay(),i=d3.time.weekOfYear(e);return"M"+(a+1)*l+","+r*l+"H"+a*l+"V"+7*l+"H"+i*l+"V"+(n+1)*l+"H"+(i+1)*l+"V0H"+(a+1)*l+"Z"}if(e){var n=t.width||960,i=t.height||136,l=t.cellSize||17,c=d3.time.format("%Y-%m-%d");r.selectAll("*").remove();var o=r.append("div").attr("class","calendarHeatmap").selectAll("svg").data(d3.range(e.from,e.to+1)).enter().append("svg").attr("width",n).attr("height",i).attr("class","RdYlGn").append("g").attr("transform","translate("+(n-53*l)/2+","+(i-7*l-1)+")");o.append("text").attr("transform","translate(-6,"+3.5*l+")rotate(-90)").style("text-anchor","middle").text(function(t){return t});var d=o.selectAll(".day").data(function(t){return d3.time.days(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("rect").attr("class","day").attr("width",l).attr("height",l).attr("x",function(t){return d3.time.weekOfYear(t)*l}).attr("y",function(t){return t.getDay()*l}).datum(c);d.append("title").text(function(t){return t}),o.selectAll(".month").data(function(t){return d3.time.months(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("path").attr("class","month").attr("d",a);var s=e.data,u=0;for(var f in s){var h=s[f];h>u&&(u=h)}var p=d3.scale.quantize().domain([0,u]).range(d3.range(11).map(function(t){return"q"+t+"-11"}));d.filter(function(t){return t in s}).attr("class",function(t){return"day "+p(s[t])}).select("title").text(function(t){return t+": "+s[t]})}})}}}).directive("circularSegment",["angularD3Svc",function(t){return{restrict:"E",replace:!1,scope:{ngData:"="},link:function(e,r){var a=d3.select(r[0]),n=t.getId();e.$watch("ngData",function(t){if(t){a.selectAll("*").remove();var e=d3.select(r[0].parentNode).node().getBoundingClientRect(),i={top:20,right:20,bottom:20,left:20},l=e.width-i.left-i.right,c=e.height-i.top-i.bottom,o=Math.min(l,c)/2,d=l,s=t*d,u=o-s,f=a.append("svg").attr("width",l).attr("height",c);f.append("defs").append("clipPath").attr("id",n).append("rect").attr("x",-o).attr("y",u).attr("width",d).attr("height",s);var h=f.append("g").attr("transform","translate("+l/2+","+c/2+")");h.append("circle").attr("class","filler").attr("r",o).attr("clip-path",'url("#'+n+'")'),h.append("circle").attr("r",o).attr("class","outline")}})}}}]).directive("lineChart",function(){return{restrict:"E",replace:!1,scope:{ngData:"="},link:function(t,e){var r=d3.select(e[0]),a=d3.select(e[0].parentNode).node().getBoundingClientRect(),n={top:20,right:20,bottom:30,left:50},i=a.width-n.left-n.right,l=a.height-n.top-n.bottom;t.$watch("ngData",function(t){if(t){var e=d3.time.scale().range([0,i]),a=d3.scale.linear().range([l,0]),c=d3.svg.axis().scale(e).orient("bottom").tickFormat(function(e,r){return t.data[d3.format("s")(e,r)].x}),o=d3.svg.axis().scale(a).orient("left"),d=d3.svg.line().x(function(t,r){return e(r)}).y(function(t){return a(t.y)});r.selectAll("*").remove();var s=r.append("svg").attr("width",i+n.left+n.right).attr("height",l+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");e.domain([0,t.data.length-1]),a.domain(d3.extent(t.data,function(t){return t.y})),s.append("g").attr("class","x axis").attr("transform","translate(0,"+l+")").call(c),s.append("g").attr("class","y axis").call(o).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(t.axis.y),s.append("path").datum(t.data).attr("class","line").attr("d",d)}})}}}).directive("pieChart",function(){return{restrict:"E",replace:!1,scope:{ngData:"="},link:function(t,e){var r=d3.select(e[0]),a=d3.select(e[0].parentNode).node().getBoundingClientRect(),n={top:20,right:20,bottom:20,left:20},i=a.width-n.left-n.right,l=a.height-n.top-n.bottom,c=Math.min(i,l)/2;t.$watch("ngData",function(t){if(t){var e=d3.scale.ordinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]),a=d3.svg.arc().outerRadius(c-10).innerRadius(c-70),n=d3.layout.pie().sort(null).value(function(t){return t.y});r.selectAll("*").remove();var o=r.append("svg").attr("width",i).attr("height",l).append("g").attr("transform","translate("+i/2+","+l/2+")"),d=o.selectAll(".arc").data(n(t.data)).enter().append("g").attr("class","arc");d.append("path").attr("d",a).style("fill",function(t){return e(t.data.x)}),d.append("text").attr("transform",function(t){return"translate("+a.centroid(t)+")"}).attr("dy",".35em").text(function(t){return t.data.x})}})}}}).directive("horizontalTreeChart",function(){return{restrict:"E",replace:!1,scope:{ngData:"=",ngCollapse:"@",ngSpacer:"@"},link:function(t,e){var r=d3.select(e[0]),a=d3.select(e[0].parentNode).node().getBoundingClientRect(),n={top:20,right:20,bottom:20,left:20},i=a.width-n.left-n.right,l=a.height-n.top-n.bottom,c=parseInt(t.ngSpacer||"180");t.$watch("ngData",function(e){function a(t){t.children&&(t._children=t.children,t._children.forEach(a),t.children=null)}function o(t){var e=f.nodes(d).reverse(),r=f.links(e);e.forEach(function(t){t.y=t.depth*c});var a=p.selectAll("g.node").data(e,function(t){return t.id||(t.id=++s)}),n=a.enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+t.y0+","+t.x0+")"}).on("click",function(t){t.children?(t._children=t.children,t.children=null):(t.children=t._children,t._children=null),o(t)});n.append("circle").attr("r",1e-6).style("fill",function(t){return t._children?"lightsteelblue":"#fff"}),n.append("text").attr("x",function(t){return t.children||t._children?-13:13}).attr("dy",".35em").attr("text-anchor",function(t){return t.children||t._children?"end":"start"}).text(function(t){return t.name}).style("fill-opacity",1e-6);var i=a.transition().duration(u).attr("transform",function(t){return"translate("+t.y+","+t.x+")"});i.select("circle").attr("r",10).style("fill",function(t){return t._children?"lightsteelblue":"#fff"}),i.select("text").style("fill-opacity",1);var l=a.exit().transition().duration(u).attr("transform",function(e){return"translate("+t.y+","+t.x+")"}).remove();l.select("circle").attr("r",1e-6),l.select("text").style("fill-opacity",1e-6);var g=p.selectAll("path.link").data(r,function(t){return t.target.id});g.enter().insert("path","g").attr("class","link").attr("d",function(e){var r={x:t.x0,y:t.y0};return h({source:r,target:r})}),g.transition().duration(u).attr("d",h),g.exit().transition().duration(u).attr("d",function(e){var r={x:t.x,y:t.y};return h({source:r,target:r})}).remove(),e.forEach(function(t){t.x0=t.x,t.y0=t.y})}if(e){var d,s=0,u=750,f=d3.layout.tree().size([l,i]),h=d3.svg.diagonal().projection(function(t){return[t.y,t.x]});r.selectAll("*").remove();var p=r.append("svg").attr("width",i+n.right+n.left).attr("height",l+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");d=t.ngData,d.x0=l/2,d.y0=0,t.ngCollapse&&d.children.forEach(a),o(d)}})}}}).directive("treeChart",function(){return{restrict:"E",replace:!1,scope:{ngData:"=",ngCollapse:"@",ngNodeWidth:"@",ngNodeHeight:"@",ngDuration:"@",ngSpacer:"@"},link:function(t,e){var r=d3.select(e[0]),a=d3.select(e[0].parentNode).node().getBoundingClientRect(),n={top:20,right:20,bottom:20,left:20},i=a.width-n.left-n.right,l=a.height-n.top-n.bottom,c=i/2,o=t.ngDuration||750,d=parseInt(t.ngNodeWidth||"60"),s=parseInt(t.ngNodeHeight||"30"),u=parseInt(t.ngSpacer||s+10);t.$watch("ngData",function(e){function a(t){t.children&&(t._children=t.children,t._children.forEach(a),t.children=null)}function f(t){var e=m.nodes(y).reverse(),r=m.links(e);e.forEach(function(t){t.y=t.depth*u});var a=x.selectAll("g.node").data(e,function(t){return t.id||(t.id=++g)}),n=a.enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+t.x0+","+t.y0+")"}).on("click",h);n.append("rect").attr("width",d).attr("height",s).attr("stroke","black").attr("stroke-width",1).attr("class",function(t){return t._children?"expandable":""}).style("fill",function(t){return t._children?"lightsteelblue":"#fff"}),n.append("title").text(function(t){return null==t.title?"":t.title}),n.append("text").attr("x",d/2).attr("y",s/2).attr("dy",".35em").attr("text-anchor","middle").text(function(t){return t.name});var i=a.transition().duration(o).attr("transform",function(t){return"translate("+t.x+","+t.y+")"});i.select("rect").attr("width",d).attr("height",s).attr("stroke","black").attr("stroke-width",1).style("fill",function(t){return t._children?"lightsteelblue":"#fff"}),i.select("text").style("fill-opacity",1);var l=a.exit().transition().duration(o).attr("transform",function(e){return"translate("+t.x+","+t.y+")"}).remove();l.select("rect").attr("width",d).attr("height",s).attr("stroke","black").attr("stroke-width",1),l.select("text");var c=x.selectAll("path.link").data(r,function(t){return t.target.id});c.enter().insert("path","g").attr("class","link").attr("x",d/2).attr("y",s/2).attr("d",function(e){var r={x:t.x0,y:t.y0};return v({source:r,target:r})}),c.transition().duration(o).attr("d",v),c.exit().transition().duration(o).attr("d",function(e){var r={x:t.x,y:t.y};return v({source:r,target:r})}).remove(),e.forEach(function(t){t.x0=t.x,t.y0=t.y})}function h(t){t.children?(t._children=t.children,t.children=null):(t.children=t._children,t._children=null),f(t)}function p(){x.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")}if(e){var g=0,m=d3.layout.tree().nodeSize([d+10,s]),v=d3.svg.diagonal().projection(function(t){return[t.x+d/2,t.y+s/2]}),x=r.append("svg").attr("width",i).attr("height",l).call(zm=d3.behavior.zoom().scaleExtent([1,3]).on("zoom",p)).append("g").attr("transform","translate("+c+","+n.top+")");zm.translate([c,n.top]);var y=t.ngData;y.x0=0,y.y0=l/2,t.ngCollapse&&y.children.forEach(a),f(y)}})}}});